(()=>{const startBtn=document.getElementById('startBtn'), stopBtn=document.getElementById('stopBtn'), staticBtn=document.getElementById('staticCheck'), urlInput=document.getElementById('urlInput'), status=document.getElementById('status'), hval=document.getElementById('hval'), bval=document.getElementById('bval'), pval=document.getElementById('pval'), badge=document.getElementById('badge'), overlay=document.getElementById('overlay'), overlayTitle=document.getElementById('overlayTitle'), overlayMsg=document.getElementById('overlayMsg'), dismiss=document.getElementById('dismiss'); let socket=null, session_id=null, metricsInterval=null, typingEvents=[], mouseDistances=0, lastMouse=null, clickTimes=[], lastClick=null, scrollDistances=0, lastScroll=null, blocked=false; urlInput.addEventListener('input', ()=>{typingEvents.push(Date.now())}); document.addEventListener('mousemove',(e)=>{ if(lastMouse){const dx=e.clientX-lastMouse.x; const dy=e.clientY-lastMouse.y; mouseDistances+=Math.sqrt(dx*dx+dy*dy);} lastMouse={x:e.clientX,y:e.clientY};}); document.addEventListener('click',(e)=>{ const t=Date.now(); if(lastClick) clickTimes.push(t-lastClick); lastClick=t;}); document.addEventListener('scroll',(e)=>{ if(lastScroll!==null) scrollDistances+=Math.abs(window.scrollY-lastScroll); lastScroll=window.scrollY; },{passive:true}); function computeBehavior(){ let typing_cps=0; if(typingEvents.length>=2){ const duration=(typingEvents[typingEvents.length-1]-typingEvents[0])/1000; typing_cps=typingEvents.length/Math.max(0.001,duration);} const avg_mouse_speed=mouseDistances/Math.max(0.001,((typingEvents.length>0)?((typingEvents[typingEvents.length-1]-typingEvents[0])/1000):1)); const click_std=(function(){ if(clickTimes.length===0) return 0; let mean=clickTimes.reduce((a,b)=>a+b,0)/clickTimes.length; let v=clickTimes.reduce((a,b)=>a+(b-mean)*(b-mean),0)/clickTimes.length; return Math.sqrt(v); })(); const scroll_speed=scrollDistances/Math.max(0.001,((typingEvents.length>0)?((typingEvents[typingEvents.length-1]-typingEvents[0])/1000):1)); return {typing_cps, avg_mouse_speed, click_std:click_std, scroll_speed}; } startBtn.addEventListener('click', ()=>{ if(socket) return; socket=io(); status.textContent='Status: connecting...'; socket.on('connect', ()=>{ status.textContent='Status: connected'; session_id=socket.id; socket.emit('join',{room:session_id}); }); socket.on('update',(data)=>{ if(data.session_id!==session_id) return; hval.textContent=data.homoglyph_score; bval.textContent=data.behavior_score; pval.textContent=data.phishing_score; badge.innerHTML=''; const span=document.createElement('div'); if(data.risk_level==='Low'){ span.className='badge-low'; span.textContent='LOW RISK'; alert('Low Risk — Access allowed'); } else if(data.risk_level==='Medium'){ span.className='badge-med'; span.textContent='MEDIUM RISK'; alert('Medium Risk — Alert sent'); } else { span.className='badge-high'; span.textContent='HIGH RISK'; alert('High Risk — Blocked'); blocked=true; overlay.classList.remove('d-none'); overlayTitle.textContent='Blocked'; overlayMsg.textContent='High risk detected for '+data.url;} badge.appendChild(span); }); socket.on('disconnect', ()=>{ status.textContent='Status: disconnected'; socket=null; session_id=null; }); metricsInterval=setInterval(()=>{ if(!socket||blocked) return; const url=urlInput.value.trim(); const behavior=computeBehavior(); socket.emit('metrics',{session_id:session_id,url:url,behavior:behavior}); },2000); }); stopBtn.addEventListener('click', ()=>{ if(metricsInterval) clearInterval(metricsInterval); if(socket){ socket.disconnect(); socket=null; status.textContent='Status: disconnected'; session_id=null; }}); staticBtn.addEventListener('click', async ()=>{ const url=urlInput.value.trim(); if(!url){ alert('Enter URL'); return;} const behavior=computeBehavior(); try{ const resp=await fetch('/api/check',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify({url,behavior})}); const data=await resp.json(); hval.textContent=data.homoglyph_score; bval.textContent=data.behavior_score; pval.textContent=data.phishing_score; badge.innerHTML=''; const span=document.createElement('div'); if(data.risk_level==='Low'){ span.className='badge-low'; span.textContent='LOW RISK'; alert('Low Risk — Access allowed'); } else if(data.risk_level==='Medium'){ span.className='badge-med'; span.textContent='MEDIUM RISK'; alert('Medium Risk — Alert sent'); } else { span.className='badge-high'; span.textContent='HIGH RISK'; alert('High Risk — Blocked'); blocked=true; overlay.classList.remove('d-none'); overlayTitle.textContent='Blocked'; overlayMsg.textContent='High risk detected for '+data.url; } badge.appendChild(span);}catch(e){ alert('Static check failed: '+e.message);} }); dismiss.addEventListener('click', ()=>{ overlay.classList.add('d-none'); blocked=false; }); })();